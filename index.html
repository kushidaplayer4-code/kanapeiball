
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Swipe Billiard Fixed</title>
<style>
  body {
    margin: 0;
    background: #0b6623;
    touch-action: none;
  }
  canvas {
    display: block;
  }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

const friction = 0.985;
const POWER = 0.12;

class Ball {
  constructor(x, y, imgSrc, r = 40) {
    this.x = x;
    this.y = y;
    this.vx = 0;
    this.vy = 0;
    this.r = r;
    this.img = new Image();
    this.img.src = imgSrc;
  }

  update() {
    this.x += this.vx;
    this.y += this.vy;

    this.vx *= friction;
    this.vy *= friction;

    // 壁反射（位置を戻す）
    if (this.x < this.r) {
      this.x = this.r;
      this.vx *= -1;
    }
    if (this.x > canvas.width - this.r) {
      this.x = canvas.width - this.r;
      this.vx *= -1;
    }
    if (this.y < this.r) {
      this.y = this.r;
      this.vy *= -1;
    }
    if (this.y > canvas.height - this.r) {
      this.y = canvas.height - this.r;
      this.vy *= -1;
    }
  }

  draw() {
    ctx.drawImage(
      this.img,
      this.x - this.r,
      this.y - this.r,
      this.r * 2,
      this.r * 2
    );
  }
}

// 玉3つ
const balls = [
  new Ball(canvas.width * 0.3, canvas.height / 2, "ball1.jpeg"),
  new Ball(canvas.width * 0.5, canvas.height / 2, "ball2.jpeg"),
  new Ball(canvas.width * 0.7, canvas.height / 2, "ball3.jpeg")
];

let startX = 0;
let startY = 0;
let selectedBall = null;

canvas.addEventListener("touchstart", e => {
  const t = e.touches[0];
  startX = t.clientX;
  startY = t.clientY;

  // 触った玉を探す
  selectedBall = null;
  for (const b of balls) {
    const dx = t.clientX - b.x;
    const dy = t.clientY - b.y;
    if (Math.hypot(dx, dy) <= b.r) {
      selectedBall = b;
      break;
    }
  }
});

canvas.addEventListener("touchend", e => {
  if (!selectedBall) return;

  const t = e.changedTouches[0];
  const dx = startX - t.clientX;
  const dy = startY - t.clientY;

  // 速度を上書き（加算しない）
  selectedBall.vx = dx * POWER;
  selectedBall.vy = dy * POWER;

  selectedBall = null;
});

function collide(b1, b2) {
  const dx = b2.x - b1.x;
  const dy = b2.y - b1.y;
  const dist = Math.hypot(dx, dy);
  const minDist = b1.r + b2.r;

  if (dist < minDist) {
    const angle = Math.atan2(dy, dx);
    const overlap = minDist - dist;

    // 食い込み解消
    b1.x -= Math.cos(angle) * overlap / 2;
    b1.y -= Math.sin(angle) * overlap / 2;
    b2.x += Math.cos(angle) * overlap / 2;
    b2.y += Math.sin(angle) * overlap / 2;

    // 速度交換（簡易）
    const v1 = Math.hypot(b1.vx, b1.vy);
    const v2 = Math.hypot(b2.vx, b2.vy);

    b1.vx = v2 * Math.cos(angle);
    b1.vy = v2 * Math.sin(angle);
    b2.vx = v1 * Math.cos(angle);
    b2.vy = v1 * Math.sin(angle);
  }
}

function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let i = 0; i < balls.length; i++) {
    balls[i].update();
    balls[i].draw();
    for (let j = i + 1; j < balls.length; j++) {
      collide(balls[i], balls[j]);
    }
  }

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
